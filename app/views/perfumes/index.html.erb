<div class="container mt-5">
  <div class="text-center">
    <h1 class="display-4">TOUS LES PARFUMS</h1>
    <p class="lead">Une sélection de parfum choisis par nos soins, qui évolue au fil des saisons.</p>
  </div>
  <div class="row mb-4">
    <div class="col text-end">
      <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas" data-bs-target="#filterCanvas" aria-controls="filterCanvas">
        <i class="bi bi-funnel"></i> FILTRER ET TRIER
      </button>
    </div>
  </div>
  <div class="offcanvas offcanvas-end" tabindex="-1" id="filterCanvas" aria-labelledby="filterCanvasLabel">
    <div class="offcanvas-header">
      <h5 class="offcanvas-title" id="filterCanvasLabel">FILTRER ET TRIER</h5>
      <button type="button" class="btn-close" data-bs-dismiss="offcanvas" aria-label="Close"></button>
    </div>
    <div class="offcanvas-body">
      <%= form_with url: perfumes_path, method: :get, local: true do |form| %>
        <div class="mb-3">
          <label for="intensity" class="form-label">INTENSITÉ</label>
          <%= form.select :intensity, options_for_select([['Sélectionner', ''], ['1', 1], ['2', 2], ['3', 3], ['4', 4], ['5', 5]], params[:intensity]), { include_blank: true }, { class: 'form-select' } %>
        </div>
        <div class="mb-3">
          <label for="heart_notes" class="form-label">NOTES DE COEUR</label>
          <%= form.select :heart_notes, options_for_select([['Sélectionner', ''], 'Bergamote', 'Lavande', 'Mandarine', 'Amande']), { include_blank: true }, { class: 'form-select' } %>
        </div>
        <div class="mb-3">
          <label for="head_notes" class="form-label">NOTES DE TÊTE</label>
          <%= form.select :head_notes, options_for_select([['Sélectionner', ''], 'Iris', 'Jasmin Sambac', 'Basilic', 'Cuir']), { include_blank: true }, { class: 'form-select' } %>
        </div>
        <div class="mb-3">
          <label for="base_notes" class="form-label">NOTES DE FOND</label>
          <%= form.select :base_notes, options_for_select([['Sélectionner', ''], 'Vanille', 'Bois de santal', 'Thé vert', 'Vanille']), { include_blank: true }, { class: 'form-select' } %>
        </div>
        <div class="mb-3">
          <label for="sort" class="form-label">TRIER PAR</label>
          <div>
            <div class="form-check">
              <%= form.radio_button :sort, 'price_asc', checked: params[:sort] == 'price_asc', class: 'form-check-input' %>
              <label class="form-check-label" for="price_asc">Prix croissant</label>
            </div>
            <div class="form-check">
              <%= form.radio_button :sort, 'price_desc', checked: params[:sort] == 'price_desc', class: 'form-check-input' %>
              <label class="form-check-label" for="price_desc">Prix décroissant</label>
            </div>
          </div>
        </div>
        <div class="d-flex justify-content-between">
          <button type="reset" class="btn btn-secondary">Effacer</button>
          <button type="submit" class="btn btn-primary">Valider</button>
        </div>
      <% end %>
    </div>
  </div>
  <div class="row row-cols-1 row-cols-md-2 row-cols-lg-4 g-4">
    <% @perfumes.each do |perfume| %>
      <div class="col">
        <div class="card h-100">
          <%= link_to perfume_path(perfume), class: "text-decoration-none text-dark" do %>
            <div class="position-relative">
              <img src="<%= perfume.photo %>" class="card-img-top" alt="<%= perfume.name %>">
              <% if current_user %>
                <% if current_user.favorites.exists?(perfume: perfume) %>
                  <%= link_to perfume_favorite_path(perfume, current_user.favorites.find_by(perfume: perfume)), method: :delete, class: "position-absolute top-0 end-0 btn btn-link" do %>
                    <i class="fa-solid fa-heart fa-2x"></i>
                  <% end %>
                <% else %>
                  <%= link_to perfume_favorites_path(perfume_id: perfume.id), method: :post, class: "position-absolute top-0 end-0 btn btn-link" do %>
                    <i class="fa-regular fa-heart fa-2x"></i>
                  <% end %>
                <% end %>
              <% end %>
            </div>
            <div class="card-body">
              <h5 class="card-title"><%= perfume.name %></h5>
              <p class="card-text"><%= perfume.brand %></p>
              <p class="card-text"><%= number_to_currency(perfume.price, unit: "€") %></p>
              <p class="card-text">Avis (<%= perfume.reviews.count %>)</p>
              <div class="rating">
                <% average_rating = perfume.reviews.average(:rating).to_f.round(1) %>
                <% average_rating.to_i.times do %>
                  <i class="bi bi-star-fill"></i>
                <% end %>
                <% (5 - average_rating.to_i).times do %>
                  <i class="bi bi-star"></i>
                <% end %>
              </div>
            </div>
          <% end %>
        </div>
      </div>
    <% end %>
  </div>
</div>
